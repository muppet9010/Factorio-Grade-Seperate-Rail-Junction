Bugs
----


Functionality not currently supported
-------------------------------------
    - Handle trains running out of fuel. Give them enough to get out of the tunnel entirely so the player can deal with.
    - Block train wagons being placed on invisible rails and on portals entrance track. Will have to do this via events and can't make placement invalid without blocking trains from crossing. At present if done this will cause errors.
    - Handle a train that enters a second tunnel while leaving a first tunnel. Get by global trainID's tracked. Support N tunnels in use at once.
    - Player changes a committed entering/leaving trains order. May cause reversion or need to be bleed through to dummy train/leaving end. At points the entering train will have no orders and be in manual mode. Maybe give it schedule of "USING TUNNEL - CHNAGE ORDERS ON LEAVING TRAIN PART" and just keep on forcing this & manual mode on it?
    - Handle player driven trains approaching the tunnel (will go on auto through the tunnel). Put the player in a pushing train if needed when the train reaches other side.
    - Handle 2 trains both entering the tunnel at once, due to manual control or free wheeling (manual mode with speed) second train.
    - Handle no driver/order trains that "coast" in to the tunnel due to being damaged or whatever. A train that can't power itself in this direction should be hard stopped at the tunnel entrance, otherwise treated like a player driven train. TODO in "tests/path-to-tunnel-tests.lua" related to when this functionality is supported.
    - Handle a player adding/removing a carriage from a train using a tunnel.
    - Check entering artillery trains stopped going in to the tunnel when the head has stopped coming out (signal). In vanialla an artillery train not stopped at station or in manual won't fire.
    - Handle all of the situations that a carriage/train can be destroyed. Do late on as will be time consuming and need updating on other major changes. Also cover players in trains for player with body and when in editor mode - PlayerContainers.On_TunnelRemoved(). Currently a destroyed tunnel piece rebuilt (ghost placed) by a robot caused the game to crash (creative mod), so something isn't quite right in the old tunnel segment/portal destroyed code.


Features to add
---------------
    - Support 2 tunnels crossing:
        UPDATED NOTES IN DEDICATED BRANCH FOR THIS
    - Proper Graphics:
        - Icons
        - Ingame entities as layered graphics for underneath and on top of trains.
        - In/Out signals on the entrance end of the portal should fit in to the graphics.
        - Cursor and Blueprint entity graphics for both placed and placement as both can be seen.
    - Look at TSM and LTN compatibility requirement or block them.


Concepts / Ideas
----------------
    - Review what to allow to be built on top of the tunnel segments, either just belts & power poles or anything non trains. At present is nothing, but can be driven over.
    - When a tunnel is destroyed (by force):
        - Any riding players should have their bodies dumped at the tunnel entrance, as in vanilla Factorio you can't loose a body.
        - Detect any destroyed chest's spill on ground type mods and honour their settings for dropping train contents on ground at tunnel portals.
    - Tunnel sections shouldn't collide with cliffs, but rail crossing sections should. Also check if cliff reshaping from adjacent cliff removal would destroy tunnels going under them or cause the cliffs to vanish as they can't reshape.
    - Look at if tunnel segments (not rail crossing ones) can be built under water. Should be same placement entity, just a differnet graphics entity on top to show the tunnel on the lake bed. If possible have to work out transition point.
    - Look at if tiles (concrete) can be placed over tunnel segments or something done to allow them to be paved over (even if just a visual). Maybe have tunnel segments have below tile graphics and I place tunnel tiles down, keeping a record of the old tile. This lets people concrete over and remove concrete. If the tunnel segment is removed I return the stored origional tile name back.
    - Very very fast train mods may cause issues as they can move more than 15 tiles per tick, max speed is now 7386.3km/h or 34 tiles a tick. Either block or force to slow down for tunnels on approach/usage. The mod can only handle speeds up to 7 tiles per tick as only 1 carriage can be added/removed per tick. Maybe detect the speed on the approaching train and have a variable vanishing point based on this.
    - Request for big power poles to be able to be placed on tunnel entrances to keep tunnels like rail block blurprints (MOJO style). Maybe including big power poles at both ends of the tunnel portal and in the middle with red & green wires between them? Would need to expose wire connection points though. Or have power and red/green wires transmitted through tunnels with just a connection on the entrance of each portal?
    - Remove invisible tunnel segment signals from segments not with a crossing on them as no need for them and adds track lag.
    - Look at making the entering train have a schedule of "Entering Tunnel" rather than none at present. Make it not allow player manipulation, as there's nothing to manipulate. The leaving train should be changeable once it's started leaving already.
Maybe have something when the entering train is opened saying to manage the train by the leaving part of the train. As a long train stopped both sides of a tunnel may be odd user experience if just locked.


Code Improvements
----------------
    - Tunnel usage events being raised uses some UPS per tunnel carriage activity (N)? So look to only raise if a mod has requested the eventId, as without it nothing can be listening to the events anyway.
    - Would having a single entity for each portal/segment and then just put another simple entity over the top to suppress any graphics not wanted when built achieve the desired outcome? Would mean blueprints show the placement graphics which is better than now. It would make code simplier and less fighting Factorio logic. I think the "placement" version is left over from when I was going to use pump type and custom tiles to force building on end of rail pieces. This may allow building a tunnel segment over another tunnel segment in a different orientation, need to recheck these type of scenarios. Was placement/placed seperate entities done all those months back just to let me have different graphics or does it offer something else as well? This may have impact on underwater segments (?) and if I ever want to make tunnels not be 1 solid hitbox so players can walk in to them I need the seperate placement/placed.
    - When looking to path backwards can we leave the reverse loco in place to see if the train naturally paths forwards/backwards. Rather than having to add and remove it each tick.
    - When looking to check for if train can reverse; check track segment at rear of train and see if we can detect signal directions. If the track segment doesn't allow reverse train then no need to try it this tick. May be another light way to rule out non reversible trains situations.
    - For very long trains or tunnels the rails in the underground might not be long enough. Place additional rails at the require distance from the tunnel ends. Currently 1000 tiles each side of tunnel hardcoded. Maybe default 1000 tiles runup is too long and is contributing to lag when making tunnel on large maps (track lag)?
    - Move the player riding tests to their own test(s) and remove them from other tests. Cover:
        - Tunnel journey in all orientations at high speed with 2 other trains at the same time, put player in middle train.
        - Have the train reverse mid tunnel use and at end of tunnel use (plyer returns to carriage and then back underground second time).
        - Tunnel destroyed while player underground.
        - The tests should check the player position every tick and make sure not moved far. Look to detect unexpected jumping between trains or for above and below mis-alignments. Get position before entering tunnel and exited, as should be smooth journey.
        - Do player riding in train with body and editor mode for all tests to make sure character is/isn't present is tested.
